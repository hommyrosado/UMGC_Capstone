{% extends "base.html" %}

{% block title %}Home - YouTube Downloader{% endblock %}

{% block content %}
<form method="POST" class="mb-4">
  <div class="input-group">
    <input type="text" name="query" class="form-control" placeholder="Search topic or paste YouTube URL..." required>
    <button class="btn btn-primary" type="submit">Search</button>
  </div>
</form>

{% if videos %}
<div class="d-flex flex-column gap-3">
  {% for video in videos %}
  <div class="card p-3">
    <div class="d-flex gap-3 align-items-center">
      <img src="{{ video.thumbnail }}" width="200" class="rounded">
      <div class="flex-grow-1">
        <h5>{{ video.title }} {% if video.downloaded %}<span class="text-success">âœ”</span>{% endif %}</h5>
        <button class="btn btn-success" onclick="openModal('{{ video.video_id }}', '{{ video.title | escape }}')">Download</button>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  let selectedVideoId = null;
  let progressInterval = null;
  const downloadModal = new bootstrap.Modal(document.getElementById('downloadModal'));

  function openModal(videoId, title) {
    selectedVideoId = videoId;
    document.getElementById("videoTitle").innerText = title;
    document.getElementById("progressBarFill").style.width = "0%";
    downloadModal.show();
  }

  function startDownload() {
    let fill = document.getElementById("progressBarFill");
    let percent = 0;

    progressInterval = setInterval(() => {
      if (percent < 90) {
        percent += 5;
        fill.style.width = percent + "%";
      }
    }, 300);

    fetch("/start_download", {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ video_id: selectedVideoId })
    })
    .then(response => response.json())
    .then(data => {
      clearInterval(progressInterval);
      if (data.success) {
        fill.style.width = "100%";
        setTimeout(() => {
          window.location.href = `/download_file/${data.filename}`;
          downloadModal.hide();
        }, 500);
      } else {
        alert("Download failed: " + data.error);
        downloadModal.hide();
      }
    })
    .catch(err => {
      alert("Error: " + err);
      downloadModal.hide();
    });
  }
</script>

<!-- Download Modal -->
<div class="modal fade" id="downloadModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <h5 class="modal-title">Confirm Download</h5>
      <p>Download: <strong id="videoTitle"></strong>?</p>
      <div class="progress mb-3">
        <div id="progressBarFill" class="progress-bar" role="progressbar"></div>
      </div>
      <div class="d-grid gap-2">
        <button class="btn btn-primary" onclick="startDownload()">Download</button>
        <button class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
